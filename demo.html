<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Continue in App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; padding: 24px; color: #0f172a; }
    .card { max-width: 520px; margin: 12vh auto; padding: 24px; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
    .title { font-size: 20px; font-weight: 700; margin: 0 0 8px; }
    .sub { color: #475569; margin: 0 0 16px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 16px; background: #0ea5e9; color: white; border: 0; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn:hover { background: #0284c7; }
    .muted { font-size: 13px; color: #64748b; margin-top: 12px; }
    .links { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
    .link { color: #0ea5e9; text-decoration: none; font-weight: 600; }
    .error { color: #b91c1c; background: #fef2f2; border: 1px solid #fee2e2; padding: 8px 12px; border-radius: 8px; margin: 8px 0 12px; display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="title">Continue in the Nucora app</h1>
    <p class="sub">Tap the button to finish authorization.</p>
    <div id="errorBox" class="error"></div>
    <button id="openAppBtn" class="btn" type="button">Open in Nucora</button>

    <div class="muted">If nothing happens, tap “Try again”.</div>
    <div class="links">
      <a id="retryLink" class="link" href="#">Try again</a>
      <a id="webFallback" class="link" href="/" rel="noopener">Return to website</a>
    </div>
  </div>

  <script>
    (function () {
      function getParams() {
        const p = new URLSearchParams(window.location.search);
        return {
          code: p.get('code') || '',
          state: p.get('state') || '',
          provider: p.get('provider') || '',
          error: p.get('error') || '',
          error_description: p.get('error_description') || ''
        };
      }

      function buildDeepLink(params) {
        const qp = new URLSearchParams();
        if (params.code) qp.set('code', params.code);
        if (params.state) qp.set('state', params.state);
        if (params.provider) qp.set('provider', params.provider);
        if (params.error) qp.set('error', params.error);
        if (params.error_description) qp.set('error_description', params.error_description);
        return 'nucora://success' + (qp.toString() ? ('?' + qp.toString()) : '');
      }

      function showError(msg) {
        var box = document.getElementById('errorBox');
        if (!box) return;
        box.textContent = msg;
        box.style.display = 'block';
      }

      var params = getParams();
      var deepLink = buildDeepLink(params);

      var openBtn = document.getElementById('openAppBtn');
      var retryLink = document.getElementById('retryLink');

      function openApp() {
        // Button-initiated navigation to custom scheme
        window.location.href = deepLink;
      }

      openBtn.addEventListener('click', function () {
        if (params.error) {
          showError('Authorization error: ' + (params.error_description || params.error));
        }
        openApp();
      });

      retryLink.addEventListener('click', function (e) {
        e.preventDefault();
        openApp();
      });

      // Optional Android-specific intent (use if you prefer)
      // if (/Android/i.test(navigator.userAgent)) {
      //   const intentUrl =
      //     `intent://success#Intent;scheme=nucora;package=com.nucora.app;` +
      //     (params.code ? `S.code=${encodeURIComponent(params.code)};` : '') +
      //     (params.state ? `S.state=${encodeURIComponent(params.state)};` : '') +
      //     (params.provider ? `S.provider=${encodeURIComponent(params.provider)};` : '') +
      //     `end`;
      //   // To use: replace deepLink with intentUrl in openApp()
      // }
    })();
  </script>
</body>
</html>